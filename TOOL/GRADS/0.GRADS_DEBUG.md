# GrADSのデバッグ法

[[_TOC_]]

## デバッグとは

デバッグとは、プログラム内のバグを見つけて改修する作業のことを指す。正常に機能しない、あるいは期待する結果が得られない場合には、そこにバグがある。そのバグを見つけ、期待する動作をするように改善するのがデバッグである。

⼀般的にバグは⼆種類に分けることができる。すなわち、 

1. プログラムが途中で⽌まってしまうバグ
2. 実⾏はできるが 結果がおかしいバグ

である。

1は主に**タイプミス**や**文法の誤り**に起因する。

2はそもそもの**計算方法**や，**プログラムの仕様**自体が原因であることが多い。

この2つの違いを認識しておくことは重要である。1の方が修正は容易で，2の方が難しい。



## 大部分のバグの原因はタイプミスである

人間には認知バイアス（思い込み）があるので，タイプミスは思いのほか見つけずらい（コピペのミスも含む）。そのため，「あってるはずだよなぁ」と言いながらプログラムを漫然と眺める，という事態に陥りやすい。残念ながらこれは時間の浪費にしかならない。

- **人間はケアレスミスをする**
- ケアレスミスは**プログラムの目視だけでは発見できない**

という前提に立って，**常に動作確認をしながらデバッグを行う**ことが肝要である。



## GrADSにおけるデバッグ方法

### エラーメッセージをよく読む

デバッグにおいて何よりも重要なことは，**エラーメッセージをきちんと読む**ということである。GrADSでよく目にするエラーメッセージとその対処法が下記にまとめてある。

**GrADS troubleshooting**

https://seesaawiki.jp/ykamae_grads-note/d/GrADS%20troubleshooting



### エラーメッセージの内容を把握する

読んでもよく意味がつかめない場合，**エラーメッセージを検索窓にコピペして検索する**。大抵の場合，同様のエラーで苦労した人が質問サイトに質問した内容が検索に引っかかるので，その内容をよく読む。英語である可能性もあるが，重要な情報である場合があるので，頑張って読むようにする。

多くの場合，**質問への回答を読むと，エラーの原因と対処法が書かれている**ので，その内容をよく頭に入れておく。使えそうなものは，ブラウザーの保存機能か印刷機能を用いて，内容を手元に保存しておく。



### エラーが出ている箇所を特定する

#### 疑わしい箇所の前後にsay文を入れる

例えば，下記の箇所が疑わしいとする。

```
'mixr= 0.62197*(e/(lev-e))*1000'              ;# Eq.4.1.2 (p.108) of Emanuel(1994) 
'TDL=temp*pow(1000/(lev-e),0.2854)*pow(temp/Tlcl, 0.28*0.001*mixr)'
'EPT=TDL*exp((3.036/Tlcl-0.00178)*mixr*(1.0+0.000448*mixr))' ;#Eq.39 of Bolton
```

この場合，前後にsay文を入れて，この箇所でスクリプトが停止していないか確認する。

```
say '### 1'
'mixr= 0.62197*(e/(lev-e))*1000'              ;# Eq.4.1.2 (p.108) of Emanuel(1994) 
'TDL=temp*pow(1000/(lev-e),0.2854)*pow(temp/Tlcl, 0.28*0.001*mixr)'
'EPT=TDL*exp((3.036/Tlcl-0.00178)*mixr*(1.0+0.000448*mixr))' ;#Eq.39 of Bolton
say '### 2'
```

この箇所で停止していなければ，

```
### 1
### 2
```

と表示されるはずである。

画面に表示される内容が多すぎる場合，

```
$ スクリプト名 &> LOG.LOG
```

とすると，LOG.LOGというファイルにエラーメッセージを含む画面表示の内容が出力されているので，

```
$ cat LOG.LOG
```

```
$ less LOG.LOG
```

```
$ vi LOG.LOG
```

などでエラーメッセージを確認する。



#### quit文を入れる

確実にここまでは動くはずであるというところの直後に

```
'quit'
```

を入れて，本当にエラーメッセージが出ずに正常終了するか確認する。



### スクリプトを書き換える

エラーが出ている箇所が特定出来たら，その箇所をできる限り単純な形に書き換える。例えば，

```
'd aave(T,lon=120, lon=150, lat=20, lat=50)'
```

のように計算と描画を同時に行っているような箇所は，

```
'define TAAV=aave(T,lon=120, lon=150, lat=20, lat=50)'
'd TAAV'
```

のような簡単な形にしてみる。

```
'define TAAV=aave(T,lon=120, lon=150, lat=20, lat=50)'
```

にバグがあれば，この箇所で何かしらエラーメッセージが出る可能性が高くなる。



### 値のチェック

#### 数値の出力

GrADSは変数に入っている数値を直接画面に出力させることがあまりできない仕様になっている。数値を直接見たい場合は下記のように，経度，緯度，気圧（高度），時刻をすべて特定の値に固定して，d文とsay文を使用する。

```
'set lon 130'
'set lat 30'
'set lev 1000'
'set time 00Z01JUL2021'
say '### DEBUG T'
'd T'
say result
say '### DEBUG T'
```

おおよそ予想された値になっているか確認する。例えば，地表面付近の気温であれば，おおよその値は予想できるはずである。

温度の場合は摂氏と絶対温度，混合比の場合g/kgとkg/kg，どちらの単位になっているか注意すること。その他の変数についても，**単位と常識的な値の範囲を確認しておく**と，バグが見つけやすくなる。

また，変数の値が未定義値となっている場合，値が出力されないので，その点も確認する。変数を0で割り算した場合，未定義値となることがある。



#### 生データをグラフにする

スクリプト内の計算結果が怪しい場合，計算に使った生のデータがそもそも正しいか確認する。例えば，下記のスクリプトで，EPTの値がおかしかったとする。

```
'mixr= 0.62197*(e/(lev-e))*1000'             
'TDL=temp*pow(1000/(lev-e),0.2854)*pow(temp/Tlcl, 0.28*0.001*mixr)'
'EPT=TDL*exp((3.036/Tlcl-0.00178)*mixr*(1.0+0.000448*mixr))'
'd ept'
```

その場合，下記のように計算に使っているもともとの変数(e, temp)の値が正常かどうかまず確認する。

```
'd e'
```

```
'd temp'
```



#### 計算式のチェック

それでも結果がおかしい場合，計算過程を分解して，結果を確認していく。例えば，下記の部分の計算が怪しいとする。

```
'mixr= 0.62197*(e/(lev-e))*1000'
```

この場合，まずlev-eの値を手計算の結果と比較してみる。levはGrADS独特の変数の一つで，ユーザーが事前に指定しなくても，CTLファイルで指定した気圧(高度)の値が自動的に入る。lon (経度), lat (緯度)も同様である。



#### 次元を落としてデータをグラフにする

できる限り単純な形のグラフを書いてみる。

##### 経度方向の分布の例

緯度，気圧(高度)，時刻を固定して，経度方向の分布をみる。

```
'set lon 120 150'
'set lat 30'
'set lev 1000'
'set time 00Z01JUL2021'
'd T'
```



##### 緯度方向の分布の例

経度，気圧(高度)，時刻を固定して，緯度方向の分布をみる。

```
'set lon 120'
'set lat 30 50'
'set lev 1000'
'set time 00Z01JUL2021'
'd T'
```



##### 鉛直プロファイルの例

緯度，経度，時刻を固定して，気圧(高度)方向の分布をみる。

```
'set lon 120'
'set lat 30'
'set lev 1000'
'set time 00Z01JUL2021'
'd T'
```



##### 時系列の例

経度，緯度，気圧（高度）を固定して，時間変化をみる

```
'set lon 130'
'set lat 30'
'set lev 1000'
'set time 00Z01JUL2021 00Z02JUL2021'
'd T'
```



### 動作をチェックする

書き換えたスクリプトを実行させ，エラーメッセージを確認する。正常に動作しない場合，上記を繰り返す。



## バグの例

典型的なエラーを例示する。各項目は次の要素で構成される。

- エラーメッセージの抜粋

- 正常に動作するスクリプト, CTLファイルとの相違点

  

### スペルミス

バグの大部分を占める。

```
Unknown command: et
```

```
$ diff ex01.sh ex01d0.sh
20c20
< 'set lon $LONW $LONE'
---
> 'et lon $LONW $LONE'
```

setとすべきところをetとしている。



### CTLファイルのファイル名が間違っている

```
Open Error:  Can't open description file
```

```
$ diff ex01.sh ex01d.sh
16c16,17
< 'open gsm_t.ctl'
---
> 'open sm_t.ctl'
> #D 'open gsm_t.ctl'
```

```
$ ls sm_t.ctl
ls: sm_t.ctl にアクセスできません: そのようなファイルやディレクトリはありません
```



### CTLファイルに記載されたデータファイルが存在しない

この場合，CTLファイルはopenで開けるので，少々バグが見つけずらい

```
Cannot contour grid - all undefined values 
```

```
$ diff ex01.sh ex01d2.sh 
16c16
< 'open gsm_t.ctl'
---
> 'open gsm_t_d.ctl'

```

```
$ diff gsm_t.ctl gsm_t_d.ctl
1c1
< dset /work01/DATA/GSM/%y4/Z__C_RJTD_%y4%m2%d2%h20000_GSM_GPV_Rgl_FD0000_grib2.bin
---
> dset /work01/GSM/%y4/Z__C_RJTD_%y4%m2%d2%h20000_GSM_GPV_Rgl_FD0000_grib2.bin
```

gsm_t_d.ctlに記載されているdsetの値，

```
/work01/GSM/%y4/Z__C_RJTD_%y4%m2%d2%h20000_GSM_GPV_Rgl_FD0000_grib2.bin
```

に誤りがある。/work01/DATAとすべきところが，/work01/GSMとなっている。



### CTLファイルに記載された範囲外のデータを指定した

```
Data Request Warning:  Request is completely outside file limits
```

```
$ diff ex01.sh ex01d3.sh
10c10
< TIME0=12Z03JUL2021
---
> TIME0=12Z03JUL2022
```

```
$ grep -n 'tdef' gsm_t.ctl 
13:tdef   8 linear 00Z02jul2021 6hr
```

gsm_t.ctlで指定されている時間は，00Z02jul2021から48時間後 (6hr x 8)までのデータであるが，ex01d3.shでは，2022年のデータを指定している。



## 休憩を入れる

プログラムのバグは，スペルミスなど非常に小さな誤りに起因することが多い。

これを疲れた状態で発見するのは容易なことではない。デバッグ作業は目を酷使するので，適度に休憩を入れた方が効率が上がることが多い。モニターを眺める作業を行う場合，1時間に一回は休憩を入れるべきとされている

https://www.fujitsu.com/jp/about/businesspolicy/tech/design/ud/vdt/index-page2.html

眼精疲労は目の筋肉の疲労なので，ストレッチも活用するとよい

https://kokoro.mhlw.go.jp/ps/tokyo_stretch_06.html

深呼吸，散歩もよい方法である。体を動かすことで，誤りに気が付くことがよくある。

休憩時間中はスマホを手から放して，休憩に専念することが肝要（スマホ画面の凝視はパソコンのモニタの凝視と変わらない）。



## 極意

プログラムにわけのわからないバグが発⽣した場合、 私たちが普通取る⾏動は、プログラムを眺めて、上から順に追っていく ことであろう。これは、「⾃分は正しくプログラムを書いている筈」という 先⼊観が邪魔をして、まず成功しない。

だいたいが 最後までプログラムを⾒終わって「うーん、合っているはずだよなぁ」と つぶやくのがせいぜいである。 

合っていたらバグなんて発⽣しない。そもそもバグが起きたら 「なんでだよ〜」と思う時点で罠にはまっていると⾔ってよい。 バグは全て⾃分のせいだということを思い返そう。

プログラムを眺めながら頭の中でプログラムを仮想実⾏する⽅法は あまり良くない。そこで、逆に「こういうバグが発⽣するとしたら どういう原因が考えられるだろう」と考える。その仮説に従って，起こりうることを次の手順でチェックしていく。

1. バグの原因となりうる具体的な条件をできるだけ多くリストアップする
2. それぞれの条件について、それが原因であることを確かめるための条件を考える
3. 上記の条件を⼀つ⼀つチェックする
4. これで発⾒できなかった場合には、1に戻る

このように、「考えられる原因」と「その対策」を ⼗分練ってからプログラムを⾒る。そのとき 「⾃分はあっているはず」という偏⾒が薄れ、 「バグがあるとしたらこのあたりのはず」という⾒⽅になっているだろう。 これならバグの発⾒率が⾼くなる。





## まとめ

要点は下記の通り。

- エラーに関係する情報を収集する
- エラーの要因は何か仮説を立てる
- 仮説を検証する方法を考える
- 仮説を検証する
